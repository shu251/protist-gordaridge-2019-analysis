---
title: "GR-grazing-analysis-SKH-2020"
author: "Sarah Hu"
date: "10/22/2020"
output: 
  html_document:
    number_sections: true
    theme: spacelab
    highlight: monochrome
    collapsed: false
    toc: true
    toc_depth: 3
    toc_float: true
  pdf_document:
    toc: true
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=FALSE)
```
# Overview
Hu et al. _in prep_. **Protistan grazing and biogeography at Gorda Ridge hydrothermal vent field**

Code for analysis and figure generation for FLP disappearance experiments. 

# Import 18S ASV table & quality control
```{r Set up environment}
library(tidyverse); library(cowplot)
```

```{r Import raw count data}
# Metadata for each grazing experiment
### Including dive ID, vent/site name, incubation parameters
exp_list <- read.table("data-input/Table1_grazingexp_list.txt",header=T, fill=T, sep="\t")
exp_IDs <- exp_list %>%
    separate(Sample.ID, c("Cruise", "SampleNumber"), "-", remove = FALSE) %>% 
    data.frame #Split column
# head(exp_IDs[1:3,])

# Import all cell count information from FLP disappearance experiments
counts <- read.csv("data-input/GordaRidge-cell-count-results.csv")
counts_df <- counts %>%
    separate(Site, c("SampleOrigin", "SampleNumber", "Stain"), "-", remove = FALSE) %>%
    separate(ID, c("TimePoint", "Bottle", "Replicate"), "-", remove = FALSE) %>%
    data.frame
# head(counts_df[1:3,])


# Import prok counts
prok<-read.table("data-input/prok_counts.txt",header=T, fill=T, sep="\t"); head(prok[1:2,])
```

```{r Join count data}
# Join count data with experiment IDs so each vent site can be identified by name:
counts_df_ids <- counts_df %>%
    left_join(exp_IDs) %>%
    unite(Sample, TimePoint, Bottle, sep = "_", remove = FALSE) %>%
    data.frame
# head(counts_df_ids) # View combined table
colnames(counts_df_ids)
```

## Calculate error rate
Counts from Vent sample 110 T0 control were repeated three times (3 separate slides). Results are used below as technical replicates to estimate the percentage error rate.

```{r Determine error rate}
# Need to determine error rate across technical replicates. 
## Prepped a single sample 3 times (3 different days); this was counted separately to to estimate a personal error rate
# This is the % max and min that we will consider to be a margin of error
tech_check <- counts_df_ids %>%
    filter(Site %in% "Vent-110-DTAF" & TimePoint %in% "T0" & Bottle %in% "Ctrl" & !(Replicate %in% "R2")) %>%
    group_by(SampleOrigin, SampleNumber) %>%
    summarise(MEAN = mean(Cellsperml), STDEV = sd(Cellsperml), ERR_PER = (100*(STDEV/MEAN))) %>%
    data.frame

head(tech_check)
PERCENT_ERR <- tech_check[["ERR_PER"]]; PERCENT_ERR # Change in FLP time point to time point must exceed 16%
```

## Estimate average cells/ml
Get average FLP concentration from T0 experiments and average cells/ml from proj counts
```{r Average across replicates}
calc_FLP_avg <- counts_df_ids %>%
    group_by(SampleOrigin, SampleNumber, T, Bottle, Vent.name, Sample, Stain, T1, T2) %>%
    summarise(Avg_cellmL = mean(Cellsperml), # Average cells per ml across replicates
              sem=sd(Cellsperml)/sqrt(length(Cellsperml)), # Standard mean error
              SD=sd(Cellsperml),  #standard deviation
              var=sqrt(SD),  # variance
              Num = n()) %>% #Total number of 
    data.frame
# head(calc_FLP_avg)
```

```{r Extract t0}
# Separate T0 from other time points to calculate % differences in DTAF counts from T0 to T1 and T0 to T2
t0 <- filter(calc_FLP_avg, (T == "T0" & Stain == "DTAF")) %>%
    select(-T1, -T2, -Stain, -Num, -T, -Sample, -SD, -var, Avg_cellmL_T0 = Avg_cellmL, sem_T0 = sem) %>%
    data.frame
# head(t0)

t_ex <- filter(calc_FLP_avg, (!(T == "T0") & Stain == "DTAF")) %>%
    select(-Stain, -Num, -Sample, -SD, -var) %>%
    pivot_wider(names_from = T, values_from = c(Avg_cellmL, sem)) %>%
    data.frame
# head(t_ex)
# ?pivot_wider

bac_exp <- calc_FLP_avg %>%
    filter(Stain %in% "DAPI") %>%
    select(-Bottle, -Stain, -T1, -T2, -SD, -var, -Num, bac_cellmL = Avg_cellmL, bac_sem = sem) %>%
    unite(SAMPLE, SampleOrigin, Vent.name, sep = "-", remove = FALSE) %>%
    data.frame
# head(bac_exp)
dapi<-as.character(unique(bac_exp$SAMPLE))
# dapi

prok_avg <- prok %>%
    group_by(Sample.location, Vent.name) %>%
    summarise(prok_avg = mean(Prok_count)) %>%
    unite(SAMPLE, Sample.location, Vent.name, sep = "-") %>%
    data.frame
# prok_avg

# Created:
# t0, t_ex, bac_exp, prok_avg
colnames(t0)
```

```{r Percent difference from T0 and timepoints}
# Calculate percent difference between T0 and T1, and T1 and T2
flp_exp_summary <- t0 %>%
    left_join(t_ex) %>%
    unite(SAMPLE, SampleOrigin, Vent.name, sep = "-", remove = FALSE) %>%
    left_join(prok_avg) %>%
    mutate(T0_T1_PercDiff = 100*(abs(Avg_cellmL_T1-Avg_cellmL_T0)/Avg_cellmL_T0),
          T0_T2_PercDiff = 100*(abs(Avg_cellmL_T2-Avg_cellmL_T0)/Avg_cellmL_T0)) %>%
    data.frame
head(flp_exp_summary)
```

### Find significant differences
```{r Report percent error}
# Prep data frame to look at loss of FLP over time for all time points
## Compare to those that exceed error rate
PERCENT_ERR
# ?pivot_longer()
# colnames(flp_exp_summary)
```

```{r Extract significant time points}
cells_long <- flp_exp_summary %>%
    select(SAMPLE, Bottle, Vent.name, Avg_cellmL_T0, Avg_cellmL_T1, Avg_cellmL_T2, T1, T2) %>%
    pivot_longer(cols = starts_with("Avg_cellmL"), names_to = "CountID", values_to = "cellmL") %>%
    separate(CountID, c("avg", "excess", "Tx"), sep = "_", remove = FALSE) %>%
    select(-avg, -excess) %>%
    data.frame

sem_long <- flp_exp_summary %>%
    select(SAMPLE, Bottle, Vent.name, sem_T0, sem_T1, sem_T2) %>%
    pivot_longer(cols = starts_with("sem"), names_to = "semID", values_to = "sem") %>%
    separate(semID, c("excess", "Tx"), sep = "_", remove = FALSE) %>%
    select(-excess) %>%
    data.frame

# head(cells_long); head(sem_long)

# Combine and fix Timepoint
flp_long_toplot <- cells_long %>%
    left_join(sem_long) %>%
    select(-semID) %>%
    add_column(Hrs = 0) %>%
    mutate(Hrs = case_when(
        Tx == "T1" ~ T1,
        Tx == "T2" ~ T2,
        TRUE ~ (as.integer(.$Hrs)))) %>%
    select(-T1, -T2) %>%
    data.frame

head(flp_long_toplot)
```

```{r Plot average cells/ml with error range}
## Plot average cells/ml for each experiment

# Factor for plotting
sample_order <- c('Plume-Mt Edwards','Vent-Mt Edwards','Vent-Candelabra','Vent-SirVentsalot','Vent-Venti latte')
sample_label <- c('Mt Edwards (plume)','Mt. Edwards','Candelabra','Sir Ventsalot','Venti latte')
sample_color <-c("lightblue","#377eb8", "#e41a1c", "#4daf4a", "#984ea3")
flp_long_toplot$SAMPLE_ORDER <- factor(flp_long_toplot$SAMPLE, levels = (sample_order), labels = sample_label)
names(sample_color) <- sample_label
bottle_order <- c("Ctrl", "Exp")
flp_long_toplot$BOTTLE <- factor(flp_long_toplot$Bottle, levels = bottle_order, labels = c("Control", "Experimental"))
```

```{r Generate plot, fig.width=8, fig.height=6}
# svg("figs/Supplementary-FLP-CTRL-PercError-plot.svg", w = 10, h = 8)
ggplot(flp_long_toplot, aes(x = Hrs, y = cellmL, fill = SAMPLE_ORDER)) +
    geom_rect(data = (subset(flp_long_toplot, Tx %in% "T0")), aes(xmin=0, xmax=40, 
            ymin=(cellmL - ((PERCENT_ERR/100)*cellmL)), 
            ymax=(cellmL + ((PERCENT_ERR/100)*cellmL))), color=NA,alpha=0.3) +
    geom_line(stat = "identity", linetype = 1, aes(group = SAMPLE)) +
    geom_errorbar(aes(ymin = (cellmL - sem), ymax = (cellmL + sem)), width = 0.1) +
    geom_point(stat = "identity", size = 3, color = "black", aes(fill = SAMPLE_ORDER, shape = SAMPLE_ORDER)) +
    scale_y_log10() +
    scale_fill_manual(values = sample_color) +
    scale_shape_manual(values = c(24,21,21,21,21)) +
    labs(y = "Log cells/ml", x = "Incubation hours") +
    facet_grid(SAMPLE_ORDER~BOTTLE, scales = "free") +
    theme_minimal() + 
    theme(panel.grid.minor = element_blank(),
          legend.title = element_blank(),
          strip.text.x = element_text(face = "bold", color = "black", hjust = 0, size = 10),
          strip.text.y = element_text(size = 6),
          panel.background = element_blank(), axis.line = element_line(colour = "black"), 
          axis.text = element_text(color = "black", size = 9))
# dev.off()
```

## Refined FLP count results
Subset FLP results to select time points with significant loss in FLP/

```{r Subset}
# Subset Experiment results and filter for those that exceed the percent error
flp_sig <- flp_exp_summary %>%
    filter(Bottle %in% "Exp") %>%
    select(-T1, -T2) %>%
    mutate(T1_sig = case_when(
        T0_T1_PercDiff > PERCENT_ERR ~ "exceeds"),
           T2_sig = case_when(T0_T2_PercDiff > PERCENT_ERR ~ "exceeds")
          ) %>%
    data.frame

# head(flp_sig)

# Select experiments that T1 exceeds percent difference
T1_tmp <- flp_sig %>%
    filter(T1_sig == "exceeds") %>%
    select(SAMPLE) %>%
    data.frame
T1_tmp$Tx = "T1"
T1_tmp$Keep = "yes"

# Select experiments that T1 was NA, but T2 was significant
T2_tmp <- flp_sig %>%
    filter(is.na(T1_sig) & T2_sig == "exceeds") %>%
    select(SAMPLE) %>%
    data.frame
T2_tmp$Tx = "T2"
T2_tmp$Keep = "yes"

keep_status <- rbind(T1_tmp, T2_tmp); keep_status

# # KEPT:
# # plume time point T2, Candelabra T2
# # Mt Edwards time point T1, Sirventsalot T1, & venti latte T1
```

```{r Join significant experiments}
# Join experiments that are significant and filter data to keep.
t <- c("T1", "T2")
flp_trend_sig <- flp_long_toplot %>%
    filter(Bottle == "Exp") %>%
    left_join(keep_status) %>%
    filter(Tx == "T0" | (Tx %in% t & Keep == "yes")) %>%
    separate(SAMPLE, c("SampleOrigin", "excess"), sep = "-", remove = FALSE) %>%
    select(-Keep, -excess) %>%
    data.frame
flp_trend_sig
```
> These values are used for all downstream grazing rate calculations, as the loss in FLP was found to exceed the microscopy count error percentage.

```{r Plot significant FLP loss, fig.width=5, fig.height=3}
# Factor for plotting
sample_order <- c('Plume-Mt Edwards','Vent-Mt Edwards','Vent-Candelabra','Vent-SirVentsalot','Vent-Venti latte')
sample_label <- c('Mt Edwards (plume)','Mt. Edwards','Candelabra','Sir Ventsalot','Venti latte')
sample_color <-c("lightblue","#377eb8", "#e41a1c", "#4daf4a", "#984ea3")
flp_trend_sig$SAMPLE_ORDER <- factor(flp_trend_sig$SAMPLE, levels = (sample_order), labels = sample_label)

plot_graze_trends <- ggplot(flp_trend_sig, 
                            aes(x = Hrs, y = cellmL, fill = SAMPLE_ORDER, shape = SampleOrigin)) +
    geom_line(stat="identity", aes(group = SAMPLE_ORDER, linetype = SampleOrigin)) +
    geom_errorbar(aes(ymin = (cellmL-sem), ymax = (cellmL+sem)), size = 0.5, width = 0.1)+
    geom_point(stat="identity", size=3, color="black") +
    scale_linetype_manual(values = c(2, 1))+
    scale_fill_manual(values = sample_color)+
    scale_shape_manual(values = c(24,21))+
    scale_y_log10(limits = c(3e3,1e5))+
    labs(y="Log cells/ml", x = "Incubation hours")+
    theme_minimal()+
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
           panel.background = element_blank(), axis.line = element_line(colour = "black"), 
           axis.text=element_text(color="black"), axis.ticks = element_line(),
           legend.title = element_blank()) +
    guides(fill = guide_legend(override.aes = list(shape = c(24,21,21,21,21))),
       shape = guide_legend(override.aes = list(fill = "black")))

plot_graze_trends
```

> Consistent loss in FLP over time

```{r Change time point label structure, as each experiments lists T0 or TF}
processed_data <- flp_trend_sig %>%
    type.convert(as.is = TRUE) %>%
    mutate(TimePoint = case_when(Tx == "T0" ~ "T0",
                                Tx != "T0" ~ "Tf")) %>%
    select(-Tx, -CountID) %>%
    pivot_wider(names_from = TimePoint, values_from = c(cellmL, sem, Hrs)) %>%
    select(-Hrs_T0) %>%
    left_join(prok_avg, by = ("SAMPLE" = "SAMPLE")) %>%
    data.frame
processed_data
```


## Calculate mortality and grazing rate
Grazing rate calculation from Connell et al. 2017
mortality factor = ln(Tf/T0) * (-1/t)
t = incubation hours reported as days
Tf = number of FLP at end of experiment
T0 = number of FLP at beginning of experiment
The natural log in R is 'log()'

```{r}
# head(processed_data)
# View(processed_data)
# library(tidyverse)
# str(processed_data)
```


```{r Grazing rate calculation}
# cellmL = prokaryote average cells per ml
graze_rate <- processed_data %>%
    # type.convert(as.is = TRUE) %>%
    group_by(SAMPLE, SampleOrigin, Vent.name, Hrs_Tf, SAMPLE_ORDER) %>%
    mutate(
        # Calculate mortality factor (m)
          MORTALITY = (log(cellmL_Tf/cellmL_T0))*(-1/(Hrs_Tf/24)),
           MORTALITY_min = (log((cellmL_Tf-sem_Tf)/(cellmL_T0-sem_T0)))*(-1/(Hrs_Tf/24)),
           MORTALITY_max = (log((cellmL_Tf+sem_Tf)/(cellmL_T0+sem_T0)))*(-1/(Hrs_Tf/24)),
           # Calculate model I G - Rate over given amount of time
           G = ((cellmL_T0 - cellmL_Tf) * (prok_avg / cellmL_T0)),
           G_min = (((cellmL_T0-sem_T0) - (cellmL_Tf-sem_Tf)) * (prok_avg / (cellmL_T0-sem_T0))),
           G_max = (((cellmL_T0+sem_T0) - (cellmL_Tf+sem_Tf)) * (prok_avg / (cellmL_T0+sem_T0))),
           # Calculate Grazing per hour
           GrazingRate_hr = (G/Hrs_Tf), 
           GrazingRate_hr_min = (G_min/Hrs_Tf),
           GrazingRate_hr_max = (G_max/Hrs_Tf),
           # Estimate prokaryote turnover % per day
           Prok_turnover = (100*(G / prok_avg)), #Convert to per day (*24)
           Prok_turnover_min = (100*(G_min / prok_avg)),
           Prok_turnover_max = (100*(G_max / prok_avg)),
           # Prok_turnover = (100*((rate * cellmL)/cellmL)), #ARCHIVE
           # Prok_turnover_min = (100*((rate_min * cellmL)/cellmL)), #ARCHIVE
           # Prok_turnover_max = (100*((rate_max * cellmL)/cellmL)) #ARCHIVE
           # Model II
           G_II = ((cellmL_T0 - cellmL_Tf) * ( ((prok_avg+prok_avg)/2 )/( ((cellmL_T0+cellmL_Tf)/2) )) )
           # G_III = ((cellmL_T0 - cellmL_Tf) * ( ((cellmL+cellmL)/2 )/( ((cellmL_T0+cellmL_Tf)/2) )) ),
           ) %>%
        data.frame
graze_rate
# View(graze_rate)
## Calculations not included:
# q  - proportion of bacteria grazed in experiment
## q_tp = ((cellmL_T0 - cellmL_Tf)/((cellmL_T0 + cellmL_Tf)/2)),
## G - are total number of bacteria grazed during experiment
# G_tp1 = ((cellmL_T0 - cellmL_Tf)*(prok_avg / cellmL_T0))
```

```{r Plot grazing rate, fig.width=4, fig.height=3}
# Re-factor - reverse color and order
sample_order <- c('Plume-Mt Edwards','Vent-Mt Edwards','Vent-Candelabra','Vent-SirVentsalot','Vent-Venti latte')
sample_label <- c('Mt Edwards (plume)','Mt. Edwards','Candelabra','Sir Ventsalot','Venti latte')
sample_color <-c("lightblue","#377eb8", "#e41a1c", "#4daf4a", "#984ea3")
graze_rate$SAMPLE_ORDER <- factor(graze_rate$SAMPLE, levels = rev(sample_order), labels = rev(sample_label))

# mortality <- ggplot(graze_rate, aes(x = SAMPLE_ORDER, y = rate, fill = SAMPLE_ORDER, shape = SampleOrigin)) + 
    # geom_errorbar(aes(ymin = rate_min, ymax = rate_max), size = 0.5, width = 0.1) +
mortality <- ggplot(graze_rate, aes(x = SAMPLE_ORDER, y = GrazingRate_hr, fill = SAMPLE_ORDER, shape = SampleOrigin)) +
geom_errorbar(aes(ymin = GrazingRate_hr_min, ymax = GrazingRate_hr_max), size = 0.5, width = 0.1) +
    geom_point(stat = "identity", size = 3, color = "black", aes(shape = SampleOrigin)) +
    scale_fill_manual(values = rev(sample_color)) +
    scale_shape_manual(values = c(24,21)) +
    coord_flip() +
    labs(x = "", y = bquote("Cells "~mL^-1 ~consumed ~hr^-1)) +
    theme_minimal() +
    theme(panel.grid.major = element_line(), panel.grid.minor = element_blank(),
           panel.background = element_blank(), axis.line = element_line(colour = "black"), 
           axis.text=element_text(color="black"), axis.ticks = element_line(),
           legend.position = "none", strip.text =element_blank())

# mortality
```

```{r Plot % turnover, fig.width=4, fig.height=3}
bar_plot <- ggplot(graze_rate, aes(x = SAMPLE_ORDER, y = Prok_turnover)) +
    geom_bar(stat = "identity", position = "stack", aes(fill = SAMPLE_ORDER)) +
    geom_errorbar(aes(ymin = Prok_turnover_min, ymax = Prok_turnover_max), size = 0.5, width = 0.1) +
   scale_fill_manual(values = rev(sample_color)) +
    scale_y_continuous(expand = c(0,0)) +
    labs(x = "", y = bquote("Prokaryote turnover %"~d^-1)) +
    coord_flip() +
    theme_minimal() +
    theme(panel.grid.major = element_line(),
           panel.background = element_blank(), axis.line = element_line(colour = "black"), 
           axis.text=element_text(color="black"), axis.ticks = element_line(),
           legend.position = "none", strip.text =element_blank())
# bar_plot
```
# Final figure generation

```{r Generate panel plot, fig.width=12, fig.height=3}
leg <- get_legend(plot_graze_trends)

# svg("figs/Grazing-results-panel-26-10-2020.svg", h = 3, w = 12)
plot_grid(plot_graze_trends + theme(legend.position = "none"),
          mortality + theme(axis.text.y = element_blank()),
          bar_plot + theme(axis.text.y = element_blank()), leg,
          axis = c("bt", "bt", "bt", "l"), align = "v", labels = c("a", "b", "c", ""), nrow = 1)
# dev.off()
```
```{r, fig.height=3, fig.width=8}
# Replot for seminar figure
# svg("gr-seminar.svg", h = 3, w = 8)
plot_grid(
          mortality + ylim(0, 11500),
          ggplot(graze_rate, aes(x = SAMPLE_ORDER, y = Prok_turnover)) +
            geom_errorbar(aes(ymin = Prok_turnover_min, ymax = Prok_turnover_max), size = 0.5, width = 0.1) +
      geom_point(stat = "identity", size = 3, aes(fill = SAMPLE_ORDER, shape = SampleOrigin)) +
    scale_fill_manual(values = rev(sample_color)) +
    scale_shape_manual(values = c(24,21)) +
    scale_y_continuous(expand = c(0,0)) +
    labs(x = "", y = bquote("Prokaryote turnover %"~d^-1)) +
    coord_flip() +
    theme_minimal() +
    theme(panel.grid.major = element_line(),
           panel.background = element_blank(), axis.line = element_line(colour = "black"), 
           axis.text=element_text(color="black"), axis.ticks = element_line(),
           legend.position = "none", strip.text =element_blank()) + ylim(0,100),
          axis = c("bt"), align = "v", nrow = 1)
# dev.off()
```

```{r Save output table}
# write_delim(graze_rate, path = "Grazing-calc-results.txt", delim = "\t")
```

# Plot in situ microbial concentration
```{r Modify data table}
prok_avg$BOTTLE = "in situ"
colnames(prok_avg)[2] <- "cellmL"
x <- as.character(unique(flp_long_toplot$SAMPLE))
prok_tmp <- filter(prok_avg, SAMPLE %in% x)
head(prok_tmp)
```
```{r Extract T0}
t0_flp <- flp_long_toplot %>%
    filter(Tx == "T0") %>%
    select(SAMPLE, BOTTLE, cellmL) %>%
    data.frame
# t0_flp

# Combine
t0_insitu_counts <- rbind(t0_flp, prok_tmp); t0_insitu_counts
```

```{r Plot in situ prok and est FLP}
# svg("flp-insitu-prok-counts.svg", w = 6, h = 5)
ggplot(t0_insitu_counts, aes(x = SAMPLE, y = cellmL, fill = BOTTLE, shape = BOTTLE)) +
    geom_point(stat = "identity", size = 4) +
    scale_y_log10(limits = c(1e3,1e6)) +
    scale_fill_manual(values = c("#d73027", "#fee090", "#4575b4")) +
    scale_shape_manual(values = c(22, 22, 23)) +
    labs(x = "", y = "cells/mL") +
    theme_bw() +
    theme(legend.title = element_blank(),
         axis.text.x = element_text(angle = 90, color = "black", size = 12, hjust = 1, vjust = 0.5),
         axis.text.y = element_text(color = "black", size = 12))
# dev.off()
```
# Estimated carbon calculations
```{r}
# Replace with the calcs to place into context with McNichol et al. work
# head(graze_rate)
# G = number of cells grazed during experiment duration
graze_rate_wCarbon <- graze_rate %>% 
  add_column(fgC_cell = 86) %>% # Add in Morono et al. 2011 value
  mutate(
    cells_consumed_perday = (G / 1), # Rate of cells consumed * in situ prok, per day
    fgC_ml_perday = (cells_consumed_perday * fgC_cell), # Convert cell amount to fg C
    ugC_L_perday = (fgC_ml_perday * (1e-09) * 1000), # Convert to ug C per L
    lower_mcnichol = 100*(ugC_L_perday / 17.3),
    upper_mcnichol = 100*(ugC_L_perday / 321.4)
  ) %>% 
  data.frame
# head(graze_rate_wCarbon)
# View(graze_rate_wCarbon)
# write_delim(graze_rate_wCarbon, path = "Grazing-calc-wCarbon-results.txt", delim = "\t")
```


```{r Session information}
sessionInfo()
```

